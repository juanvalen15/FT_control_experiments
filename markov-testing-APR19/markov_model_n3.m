%% Markov process model of Fault-Tolerant Switching Mechanism
%% clear all
clear all;
close all;
clc;

%%
n = 3;

fsw{1} = [1 1 1];
fsw{2} = [4 4 4];

LOOPS = 1000; % iterations variable

min_ps = 0.01;
max_ps = 0.2;
ps_granularity = 0.01; % granularity of Ps


for sequence = 1:length(fsw)
    
    f = fsw{sequence};
    
    exp = 0;
    
    temp_mean_probability_BL = [];
    temp_mean_probability_N1 = [];
    temp_mean_probability_N2 = [];
    temp_mean_probability_N3 = [];
    
    for Ps = min_ps:ps_granularity:max_ps % varying probability of a fault in an application slot
        
        exp = exp + 1; % just a counter for Ps index
        
        for i = 1:n
            Pfm(i)  = nchoosek(2^(i+1), 2^(i+1) - 1) * ( Ps^( 2^(i+1) - 1 ) ) * ( 1 - Ps );
            tm(i)   = 2^(i+1); % [slots]
        end
        
        x1 = ( 1-Pfm(1) )^( f(1)-1 );
        x2 = ( 1-Pfm(2) )^( f(2)-1 );
        x3 = ( 1-Pfm(3) )^( f(3)-1 );
        
        y1 = 0;
        for temp_index = 1:f(1)-1
            y1 = y1 + ( (1-Pfm(1))^(temp_index-1) )*Pfm(1);
        end
        
        y2 = 0;
        for temp_index = 1:f(2)-1
            y2 = y2 + ( (1-Pfm(2))^(temp_index-1) )*Pfm(2);
        end
        
        y3 = 0;
        for temp_index = 1:f(3)-1
            y3 = y3 + ( (1-Pfm(3))^(temp_index-1) )*Pfm(3);
        end
        
        %% transition matrix n=1 -> 2 states: Baseline mode 3
        m_01_01 = 1-Pfm(3);
        m_01_02 = Pfm(3);
        m_02_01 = 0;
        m_02_02 = 1;
        
        t_01_01 = tm(3);
        t_01_02 = tm(3);
        t_02_01 = 0;
        t_02_02 = 0;
        
        M_BL = [
            m_01_01 m_01_02; ...
            m_02_01 m_02_02
            ];
        
        T_BL = [
            t_01_01 t_01_02; ...
            t_02_01 t_02_02
            ];
        
        %% transition matrix n=1 -> 2 states
        m_01_01 = 1-Pfm(1);
        m_01_02 = Pfm(1);
        m_02_01 = 0;
        m_02_02 = 1;
        
        t_01_01 = tm(1);
        t_01_02 = tm(1);
        t_02_01 = 0;
        t_02_02 = 0;
        
        M_N1 = [
            m_01_01 m_01_02; ...
            m_02_01 m_02_02
            ];
        
        T_N1 = [
            t_01_01 t_01_02; ...
            t_02_01 t_02_02
            ];
        
        %% transition matrix n=2 -> 9 states
        m_01_01 = 0;
        m_01_02 = Pfm(1);
        m_01_03 = 1-Pfm(1);
        m_01_04 = 0;
        m_01_05 = 0;
        m_01_06 = 0;
        m_01_07 = 0;
        m_01_08 = 0;
        m_01_09 = 0;
        
        m_02_01 = 0;
        m_02_02 = 0;
        m_02_03 = 0;
        m_02_04 = 1-Pfm(2);
        m_02_05 = 0;
        m_02_06 = 0;
        m_02_07 = 0;
        m_02_08 = 0;
        m_02_09 = Pfm(2);
        
        m_03_01 = 0;
        m_03_02 = 0;
        m_03_03 = 1-(x1+y1);
        m_03_04 = 0;
        m_03_05 = x1;
        m_03_06 = 0;
        m_03_07 = 0;
        m_03_08 = 0;
        m_03_09 = y1;
        
        m_04_01 = 0;
        m_04_02 = 0;
        m_04_03 = 0;
        m_04_04 = 1-(x2+y2);
        m_04_05 = 0;
        m_04_06 = x2;
        m_04_07 = 0;
        m_04_08 = 0;
        m_04_09 = y2;
        
        m_05_01 = 0;
        m_05_02 = 0;
        m_05_03 = 0;
        m_05_04 = 0;
        m_05_05 = 1-Pfm(1);
        m_05_06 = 0;
        m_05_07 = Pfm(1);
        m_05_08 = 0;
        m_05_09 = 0;
        
        m_06_01 = 0;
        m_06_02 = 0;
        m_06_03 = 0;
        m_06_04 = 0;
        m_06_05 = 0;
        m_06_06 = 0;
        m_06_07 = 0;
        m_06_08 = 1-Pfm(2);
        m_06_09 = Pfm(2);
        
        m_07_01 = 0;
        m_07_02 = 0;
        m_07_03 = 0;
        m_07_04 = 1-Pfm(2);
        m_07_05 = 0;
        m_07_06 = 0;
        m_07_07 = 0;
        m_07_08 = 0;
        m_07_09 = Pfm(2);
        
        m_08_01 = 0;
        m_08_02 = 0;
        m_08_03 = 1-Pfm(1);
        m_08_04 = 0;
        m_08_05 = 0;
        m_08_06 = 0;
        m_08_07 = 0;
        m_08_08 = 0;
        m_08_09 = Pfm(1);
        
        m_09_01 = 0;
        m_09_02 = 0;
        m_09_03 = 0;
        m_09_04 = 0;
        m_09_05 = 0;
        m_09_06 = 0;
        m_09_07 = 0;
        m_09_08 = 0;
        m_09_09 = 1;
        
        
        M_N2 = [
            m_01_01 m_01_02 m_01_03 m_01_04 m_01_05 m_01_06 m_01_07 m_01_08 m_01_09; ...
            m_02_01 m_02_02 m_02_03 m_02_04 m_02_05 m_02_06 m_02_07 m_02_08 m_02_09; ...
            m_03_01 m_03_02 m_03_03 m_03_04 m_03_05 m_03_06 m_03_07 m_03_08 m_03_09; ...
            m_04_01 m_04_02 m_04_03 m_04_04 m_04_05 m_04_06 m_04_07 m_04_08 m_04_09; ...
            m_05_01 m_05_02 m_05_03 m_05_04 m_05_05 m_05_06 m_05_07 m_05_08 m_05_09; ...
            m_06_01 m_06_02 m_06_03 m_06_04 m_06_05 m_06_06 m_06_07 m_06_08 m_06_09; ...
            m_07_01 m_07_02 m_07_03 m_07_04 m_07_05 m_07_06 m_07_07 m_07_08 m_07_09; ...
            m_08_01 m_08_02 m_08_03 m_08_04 m_08_05 m_08_06 m_08_07 m_08_08 m_08_09; ...
            m_09_01 m_09_02 m_09_03 m_09_04 m_09_05 m_09_06 m_09_07 m_09_08 m_09_09
            ];
        
        
        % time
        t_01_01 = 0;
        t_01_02 = tm(1);
        t_01_03 = tm(1);
        t_01_04 = 0;
        t_01_05 = 0;
        t_01_06 = 0;
        t_01_07 = 0;
        t_01_08 = 0;
        t_01_09 = 0;
        
        t_02_01 = 0;
        t_02_02 = 0;
        t_02_03 = 0;
        t_02_04 = tm(2);
        t_02_05 = 0;
        t_02_06 = 0;
        t_02_07 = 0;
        t_02_08 = 0;
        t_02_09 = tm(2);
        
        t_03_01 = 0;
        t_03_02 = 0;
        t_03_03 = tm(3);
        t_03_04 = 0;
        t_03_05 = tm(3) * (f(1)-1);
        t_03_06 = 0;
        t_03_07 = 0;
        t_03_08 = 0;
        t_03_09 = tm(3) * (f(1)-1);
        
        t_04_01 = 0;
        t_04_02 = 0;
        t_04_03 = 0;
        t_04_04 = tm(2);
        t_04_05 = 0;
        t_04_06 = tm(2) * (f(2)-1);
        t_04_07 = 0;
        t_04_08 = 0;
        t_04_09 = tm(2) * (f(2)-1);
        
        t_05_01 = 0;
        t_05_02 = 0;
        t_05_03 = 0;
        t_05_04 = 0;
        t_05_05 = tm(1);
        t_05_06 = 0;
        t_05_07 = tm(1);
        t_05_08 = 0;
        t_05_09 = 0;
        
        t_06_01 = 0;
        t_06_02 = 0;
        t_06_03 = 0;
        t_06_04 = 0;
        t_06_05 = 0;
        t_06_06 = 0;
        t_06_07 = 0;
        t_06_08 = tm(2);
        t_06_09 = tm(2);
        
        t_07_01 = 0;
        t_07_02 = 0;
        t_07_03 = 0;
        t_07_04 = tm(2);
        t_07_05 = 0;
        t_07_06 = 0;
        t_07_07 = 0;
        t_07_08 = 0;
        t_07_09 = tm(2);
        
        t_08_01 = 0;
        t_08_02 = 0;
        t_08_03 = tm(1);
        t_08_04 = 0;
        t_08_05 = 0;
        t_08_06 = 0;
        t_08_07 = 0;
        t_08_08 = 0;
        t_08_09 = tm(1);
        
        t_09_01 = 0;
        t_09_02 = 0;
        t_09_03 = 0;
        t_09_04 = 0;
        t_09_05 = 0;
        t_09_06 = 0;
        t_09_07 = 0;
        t_09_08 = 0;
        t_09_09 = 0;
        
        T_N2 = [
            t_01_01 t_01_02 t_01_03 t_01_04 t_01_05 t_01_06 t_01_07 t_01_08 t_01_09; ...
            t_02_01 t_02_02 t_02_03 t_02_04 t_02_05 t_02_06 t_02_07 t_02_08 t_02_09; ...
            t_03_01 t_03_02 t_03_03 t_03_04 t_03_05 t_03_06 t_03_07 t_03_08 t_03_09; ...
            t_04_01 t_04_02 t_04_03 t_04_04 t_04_05 t_04_06 t_04_07 t_04_08 t_04_09; ...
            t_05_01 t_05_02 t_05_03 t_05_04 t_05_05 t_05_06 t_05_07 t_05_08 t_05_09; ...
            t_06_01 t_06_02 t_06_03 t_06_04 t_06_05 t_06_06 t_06_07 t_06_08 t_06_09; ...
            t_07_01 t_07_02 t_07_03 t_07_04 t_07_05 t_07_06 t_07_07 t_07_08 t_07_09; ...
            t_08_01 t_08_02 t_08_03 t_08_04 t_08_05 t_08_06 t_08_07 t_08_08 t_08_09; ...
            t_09_01 t_09_02 t_09_03 t_09_04 t_09_05 t_09_06 t_09_07 t_09_08 t_09_09
            ];
        
        
        
        
        
        
        %% transition matrix n=3 -> 14 states
        m_01_01 = 0;
        m_01_02 = Pfm(1);
        m_01_03 = 0;
        m_01_04 = 1-Pfm(1);
        m_01_05 = 0;
        m_01_06 = 0;
        m_01_07 = 0;
        m_01_08 = 0;
        m_01_09 = 0;
        m_01_10 = 0;
        m_01_11 = 0;
        m_01_12 = 0;
        m_01_13 = 0;
        m_01_14 = 0;
        
        m_02_01 = 0;
        m_02_02 = 0;
        m_02_03 = Pfm(2);
        m_02_04 = 0;
        m_02_05 = 1-Pfm(2);
        m_02_06 = 0;
        m_02_07 = 0;
        m_02_08 = 0;
        m_02_09 = 0;
        m_02_10 = 0;
        m_02_11 = 0;
        m_02_12 = 0;
        m_02_13 = 0;
        m_02_14 = 0;
        
        m_03_01 = 0;
        m_03_02 = 0;
        m_03_03 = 0;
        m_03_04 = 0;
        m_03_05 = 0;
        m_03_06 = 1-Pfm(3);
        m_03_07 = 0;
        m_03_08 = 0;
        m_03_09 = 0;
        m_03_10 = 0;
        m_03_11 = 0;
        m_03_12 = 0;
        m_03_13 = 0;
        m_03_14 = Pfm(3);
        
        m_04_01 = 0;
        m_04_02 = 0;
        m_04_03 = 0;
        m_04_04 = 1-(x1+y1);
        m_04_05 = 0;
        m_04_06 = 0;
        m_04_07 = x1;
        m_04_08 = 0;
        m_04_09 = 0;
        m_04_10 = 0;
        m_04_11 = 0;
        m_04_12 = 0;
        m_04_13 = 0;
        m_04_14 = y1;
        
        m_05_01 = 0;
        m_05_02 = 0;
        m_05_03 = 0;
        m_05_04 = 0;
        m_05_05 = 1-(x2+y2);
        m_05_06 = 0;
        m_05_07 = 0;
        m_05_08 = x2;
        m_05_09 = 0;
        m_05_10 = 0;
        m_05_11 = 0;
        m_05_12 = 0;
        m_05_13 = 0;
        m_05_14 = y2;
        
        m_06_01 = 0;
        m_06_02 = 0;
        m_06_03 = 0;
        m_06_04 = 0;
        m_06_05 = 0;
        m_06_06 = 1-(x3+y3);
        m_06_07 = 0;
        m_06_08 = 0;
        m_06_09 = x3;
        m_06_10 = 0;
        m_06_11 = 0;
        m_06_12 = 0;
        m_06_13 = 0;
        m_06_14 = y3;
        
        m_07_01 = 0;
        m_07_02 = 0;
        m_07_03 = 0;
        m_07_04 = 0;
        m_07_05 = 0;
        m_07_06 = 0;
        m_07_07 = 1-Pfm(1);
        m_07_08 = 0;
        m_07_09 = 0;
        m_07_10 = Pfm(1);
        m_07_11 = 0;
        m_07_12 = 0;
        m_07_13 = 0;
        m_07_14 = 0;
        
        m_08_01 = 0;
        m_08_02 = 0;
        m_08_03 = 0;
        m_08_04 = 0;
        m_08_05 = 0;
        m_08_06 = 0;
        m_08_07 = 0;
        m_08_08 = 0;
        m_08_09 = 0;
        m_08_10 = 0;
        m_08_11 = 1-Pfm(2);
        m_08_12 = Pfm(2);
        m_08_13 = 0;
        m_08_14 = 0;
        
        m_09_01 = 0;
        m_09_02 = 0;
        m_09_03 = 0;
        m_09_04 = 0;
        m_09_05 = 0;
        m_09_06 = 0;
        m_09_07 = 0;
        m_09_08 = 0;
        m_09_09 = 0;
        m_09_10 = 0;
        m_09_11 = 0;
        m_09_12 = 0;
        m_09_13 = 1-Pfm(3);
        m_09_14 = Pfm(3);
        
        m_10_01 = 0;
        m_10_02 = 0;
        m_10_03 = 0;
        m_10_04 = 0;
        m_10_05 = 1-Pfm(2);
        m_10_06 = 0;
        m_10_07 = 0;
        m_10_08 = 0;
        m_10_09 = 0;
        m_10_10 = 0;
        m_10_11 = 0;
        m_10_12 = 0;
        m_10_13 = 0;
        m_10_14 = Pfm(2);
        
        m_11_01 = 0;
        m_11_02 = 0;
        m_11_03 = 0;
        m_11_04 = 1-Pfm(1);
        m_11_05 = 0;
        m_11_06 = 0;
        m_11_07 = 0;
        m_11_08 = 0;
        m_11_09 = 0;
        m_11_10 = 0;
        m_11_11 = 0;
        m_11_12 = 0;
        m_11_13 = 0;
        m_11_14 = Pfm(1);
        
        m_12_01 = 0;
        m_12_02 = 0;
        m_12_03 = 0;
        m_12_04 = 0;
        m_12_05 = 0;
        m_12_06 = 1-Pfm(3);
        m_12_07 = 0;
        m_12_08 = 0;
        m_12_09 = 0;
        m_12_10 = 0;
        m_12_11 = 0;
        m_12_12 = 0;
        m_12_13 = 0;
        m_12_14 = Pfm(3);
        
        m_13_01 = 0;
        m_13_02 = 0;
        m_13_03 = 0;
        m_13_04 = 0;
        m_13_05 = 1-Pfm(2);
        m_13_06 = 0;
        m_13_07 = 0;
        m_13_08 = 0;
        m_13_09 = 0;
        m_13_10 = 0;
        m_13_11 = 0;
        m_13_12 = 0;
        m_13_13 = 0;
        m_13_14 = Pfm(2);
        
        m_14_01 = 0;
        m_14_02 = 0;
        m_14_03 = 0;
        m_14_04 = 0;
        m_14_05 = 0;
        m_14_06 = 0;
        m_14_07 = 0;
        m_14_08 = 0;
        m_14_09 = 0;
        m_14_10 = 0;
        m_14_11 = 0;
        m_14_12 = 0;
        m_14_13 = 0;
        m_14_14 = 1;
        
        M_N3 = [
            m_01_01 m_01_02 m_01_03 m_01_04 m_01_05 m_01_06 m_01_07 m_01_08 m_01_09 m_01_10 m_01_11 m_01_12 m_01_13 m_01_14; ...
            m_02_01 m_02_02 m_02_03 m_02_04 m_02_05 m_02_06 m_02_07 m_02_08 m_02_09 m_02_10 m_02_11 m_02_12 m_02_13 m_02_14; ...
            m_03_01 m_03_02 m_03_03 m_03_04 m_03_05 m_03_06 m_03_07 m_03_08 m_03_09 m_03_10 m_03_11 m_03_12 m_03_13 m_03_14; ...
            m_04_01 m_04_02 m_04_03 m_04_04 m_04_05 m_04_06 m_04_07 m_04_08 m_04_09 m_04_10 m_04_11 m_04_12 m_04_13 m_04_14; ...
            m_05_01 m_05_02 m_05_03 m_05_04 m_05_05 m_05_06 m_05_07 m_05_08 m_05_09 m_05_10 m_05_11 m_05_12 m_05_13 m_05_14; ...
            m_06_01 m_06_02 m_06_03 m_06_04 m_06_05 m_06_06 m_06_07 m_06_08 m_06_09 m_06_10 m_06_11 m_06_12 m_06_13 m_06_14; ...
            m_07_01 m_07_02 m_07_03 m_07_04 m_07_05 m_07_06 m_07_07 m_07_08 m_07_09 m_07_10 m_07_11 m_07_12 m_07_13 m_07_14; ...
            m_08_01 m_08_02 m_08_03 m_08_04 m_08_05 m_08_06 m_08_07 m_08_08 m_08_09 m_08_10 m_08_11 m_08_12 m_08_13 m_08_14; ...
            m_09_01 m_09_02 m_09_03 m_09_04 m_09_05 m_09_06 m_09_07 m_09_08 m_09_09 m_09_10 m_09_11 m_09_12 m_09_13 m_09_14; ...
            m_10_01 m_10_02 m_10_03 m_10_04 m_10_05 m_10_06 m_10_07 m_10_08 m_10_09 m_10_10 m_10_11 m_10_12 m_10_13 m_10_14; ...
            m_11_01 m_11_02 m_11_03 m_11_04 m_11_05 m_11_06 m_11_07 m_11_08 m_11_09 m_11_10 m_11_11 m_11_12 m_11_13 m_11_14; ...
            m_12_01 m_12_02 m_12_03 m_12_04 m_12_05 m_12_06 m_12_07 m_12_08 m_12_09 m_12_10 m_12_11 m_12_12 m_12_13 m_12_14; ...
            m_13_01 m_13_02 m_13_03 m_13_04 m_13_05 m_13_06 m_13_07 m_13_08 m_13_09 m_13_10 m_13_11 m_13_12 m_13_13 m_13_14; ...
            m_14_01 m_14_02 m_14_03 m_14_04 m_14_05 m_14_06 m_14_07 m_14_08 m_14_09 m_14_10 m_14_11 m_14_12 m_14_13 m_14_14
            ];
        
        
        % time
        t_01_01 = 0;
        t_01_02 = tm(1);
        t_01_03 = 0;
        t_01_04 = tm(1);
        t_01_05 = 0;
        t_01_06 = 0;
        t_01_07 = 0;
        t_01_08 = 0;
        t_01_09 = 0;
        t_01_10 = 0;
        t_01_11 = 0;
        t_01_12 = 0;
        t_01_13 = 0;
        t_01_14 = 0;
        
        t_02_01 = 0;
        t_02_02 = 0;
        t_02_03 = tm(2);
        t_02_04 = 0;
        t_02_05 = tm(2);
        t_02_06 = 0;
        t_02_07 = 0;
        t_02_08 = 0;
        t_02_09 = 0;
        t_02_10 = 0;
        t_02_11 = 0;
        t_02_12 = 0;
        t_02_13 = 0;
        t_02_14 = 0;
        
        t_03_01 = 0;
        t_03_02 = 0;
        t_03_03 = 0;
        t_03_04 = 0;
        t_03_05 = 0;
        t_03_06 = tm(3);
        t_03_07 = 0;
        t_03_08 = 0;
        t_03_09 = 0;
        t_03_10 = 0;
        t_03_11 = 0;
        t_03_12 = 0;
        t_03_13 = 0;
        t_03_14 = tm(3);
        
        t_04_01 = 0;
        t_04_02 = 0;
        t_04_03 = 0;
        t_04_04 = tm(1);
        t_04_05 = 0;
        t_04_06 = 0;
        t_04_07 = tm(1) * (f(1)-1);
        t_04_08 = 0;
        t_04_09 = 0;
        t_04_10 = 0;
        t_04_11 = 0;
        t_04_12 = 0;
        t_04_13 = 0;
        t_04_14 = tm(1) * (f(1)-1);
        
        t_05_01 = 0;
        t_05_02 = 0;
        t_05_03 = 0;
        t_05_04 = 0;
        t_05_05 = tm(2);
        t_05_06 = 0;
        t_05_07 = 0;
        t_05_08 = tm(2) * (f(2)-1);
        t_05_09 = 0;
        t_05_10 = 0;
        t_05_11 = 0;
        t_05_12 = 0;
        t_05_13 = 0;
        t_05_14 = tm(2) * (f(2)-1);
        
        t_06_01 = 0;
        t_06_02 = 0;
        t_06_03 = 0;
        t_06_04 = 0;
        t_06_05 = 0;
        t_06_06 = tm(3);
        t_06_07 = 0;
        t_06_08 = 0;
        t_06_09 = tm(3) * (f(3)-1);
        t_06_10 = 0;
        t_06_11 = 0;
        t_06_12 = 0;
        t_06_13 = 0;
        t_06_14 = tm(3) * (f(3)-1);
        
        t_07_01 = 0;
        t_07_02 = 0;
        t_07_03 = 0;
        t_07_04 = 0;
        t_07_05 = 0;
        t_07_06 = 0;
        t_07_07 = tm(1);
        t_07_08 = 0;
        t_07_09 = 0;
        t_07_10 = tm(1);
        t_07_11 = 0;
        t_07_12 = 0;
        t_07_13 = 0;
        t_07_14 = 0;
        
        t_08_01 = 0;
        t_08_02 = 0;
        t_08_03 = 0;
        t_08_04 = 0;
        t_08_05 = 0;
        t_08_06 = 0;
        t_08_07 = 0;
        t_08_08 = 0;
        t_08_09 = 0;
        t_08_10 = 0;
        t_08_11 = tm(2);
        t_08_12 = tm(2);
        t_08_13 = 0;
        t_08_14 = 0;
        
        t_09_01 = 0;
        t_09_02 = 0;
        t_09_03 = 0;
        t_09_04 = 0;
        t_09_05 = 0;
        t_09_06 = 0;
        t_09_07 = 0;
        t_09_08 = 0;
        t_09_09 = 0;
        t_09_10 = 0;
        t_09_11 = 0;
        t_09_12 = 0;
        t_09_13 = tm(3);
        t_09_14 = tm(3);
        
        t_10_01 = 0;
        t_10_02 = 0;
        t_10_03 = 0;
        t_10_04 = 0;
        t_10_05 = tm(2);
        t_10_06 = 0;
        t_10_07 = 0;
        t_10_08 = 0;
        t_10_09 = 0;
        t_10_10 = 0;
        t_10_11 = 0;
        t_10_12 = 0;
        t_10_13 = 0;
        t_10_14 = tm(2);
        
        t_11_01 = 0;
        t_11_02 = 0;
        t_11_03 = 0;
        t_11_04 = tm(1);
        t_11_05 = 0;
        t_11_06 = 0;
        t_11_07 = 0;
        t_11_08 = 0;
        t_11_09 = 0;
        t_11_10 = 0;
        t_11_11 = 0;
        t_11_12 = 0;
        t_11_13 = 0;
        t_11_14 = tm(1);
        
        t_12_01 = 0;
        t_12_02 = 0;
        t_12_03 = 0;
        t_12_04 = 0;
        t_12_05 = 0;
        t_12_06 = tm(3);
        t_12_07 = 0;
        t_12_08 = 0;
        t_12_09 = 0;
        t_12_10 = 0;
        t_12_11 = 0;
        t_12_12 = 0;
        t_12_13 = 0;
        t_12_14 = tm(3);
        
        t_13_01 = 0;
        t_13_02 = 0;
        t_13_03 = 0;
        t_13_04 = 0;
        t_13_05 = tm(2);
        t_13_06 = 0;
        t_13_07 = 0;
        t_13_08 = 0;
        t_13_09 = 0;
        t_13_10 = 0;
        t_13_11 = 0;
        t_13_12 = 0;
        t_13_13 = 0;
        t_13_14 = tm(2);
        
        t_14_01 = 0;
        t_14_02 = 0;
        t_14_03 = 0;
        t_14_04 = 0;
        t_14_05 = 0;
        t_14_06 = 0;
        t_14_07 = 0;
        t_14_08 = 0;
        t_14_09 = 0;
        t_14_10 = 0;
        t_14_11 = 0;
        t_14_12 = 0;
        t_14_13 = 0;
        t_14_14 = 0;
        
        T_N3 = [
            t_01_01 t_01_02 t_01_03 t_01_04 t_01_05 t_01_06 t_01_07 t_01_08 t_01_09 t_01_10 t_01_11 t_01_12 t_01_13 t_01_14; ...
            t_02_01 t_02_02 t_02_03 t_02_04 t_02_05 t_02_06 t_02_07 t_02_08 t_02_09 t_02_10 t_02_11 t_02_12 t_02_13 t_02_14; ...
            t_03_01 t_03_02 t_03_03 t_03_04 t_03_05 t_03_06 t_03_07 t_03_08 t_03_09 t_03_10 t_03_11 t_03_12 t_03_13 t_03_14; ...
            t_04_01 t_04_02 t_04_03 t_04_04 t_04_05 t_04_06 t_04_07 t_04_08 t_04_09 t_04_10 t_04_11 t_04_12 t_04_13 t_04_14; ...
            t_05_01 t_05_02 t_05_03 t_05_04 t_05_05 t_05_06 t_05_07 t_05_08 t_05_09 t_05_10 t_05_11 t_05_12 t_05_13 t_05_14; ...
            t_06_01 t_06_02 t_06_03 t_06_04 t_06_05 t_06_06 t_06_07 t_06_08 t_06_09 t_06_10 t_06_11 t_06_12 t_06_13 t_06_14; ...
            t_07_01 t_07_02 t_07_03 t_07_04 t_07_05 t_07_06 t_07_07 t_07_08 t_07_09 t_07_10 t_07_11 t_07_12 t_07_13 t_07_14; ...
            t_08_01 t_08_02 t_08_03 t_08_04 t_08_05 t_08_06 t_08_07 t_08_08 t_08_09 t_08_10 t_08_11 t_08_12 t_08_13 t_08_14; ...
            t_09_01 t_09_02 t_09_03 t_09_04 t_09_05 t_09_06 t_09_07 t_09_08 t_09_09 t_09_10 t_09_11 t_09_12 t_09_13 t_09_14; ...
            t_10_01 t_10_02 t_10_03 t_10_04 t_10_05 t_10_06 t_10_07 t_10_08 t_10_09 t_10_10 t_10_11 t_10_12 t_10_13 t_10_14; ...
            t_11_01 t_11_02 t_11_03 t_11_04 t_11_05 t_11_06 t_11_07 t_11_08 t_11_09 t_11_10 t_11_11 t_11_12 t_11_13 t_11_14; ...
            t_12_01 t_12_02 t_12_03 t_12_04 t_12_05 t_12_06 t_12_07 t_12_08 t_12_09 t_12_10 t_12_11 t_12_12 t_12_13 t_12_14; ...
            t_13_01 t_13_02 t_13_03 t_13_04 t_13_05 t_13_06 t_13_07 t_13_08 t_13_09 t_13_10 t_13_11 t_13_12 t_13_13 t_13_14; ...
            t_14_01 t_14_02 t_14_03 t_14_04 t_14_05 t_14_06 t_14_07 t_14_08 t_14_09 t_14_10 t_14_11 t_14_12 t_14_13 t_14_14
            ];
        
        %% iterations test
        state_BL(1,:) = [1 0];
        state_N1(1,:) = [1 0];
        state_N2(1,:) = [1 0 0 0 0 0 0 0 0];
        state_N3(1,:) = [1 0 0 0 0 0 0 0 0 0 0 0 0 0];
        
        max_T_BL = max(T_BL');              
        max_T_N1 = max(T_N1');              
        max_T_N2 = max(T_N2');              
        max_T_N3 = max(T_N3');              
        
        time_BL(1,:) = [0 0];
        time_N1(1,:) = [0 0];
        time_N2(1,:) = [0 0 0 0 0 0 0 0 0];
        time_N3(1,:) = [0 0 0 0 0 0 0 0 0 0 0 0 0 0];
        
        for i = 2:LOOPS
            state_BL(i,:) = state_BL(i-1,:) * M_BL;
            state_N1(i,:) = state_N1(i-1,:) * M_N1;
            state_N2(i,:) = state_N2(i-1,:) * M_N2;
            state_N3(i,:) = state_N3(i-1,:) * M_N3;
            
            
            DELTA_T_BL = max_T_BL( find( state_BL(i,:)==max(state_BL(i,:)) ) );
            DELTA_T_N1 = max_T_N1( find( state_N1(i,:)==max(state_N1(i,:)) ) );
            DELTA_T_N2 = max_T_N2( find( state_N2(i,:)==max(state_N2(i,:)) ) );
            DELTA_T_N3 = max_T_N3( find( state_N3(i,:)==max(state_N3(i,:)) ) );            
            
            time_BL(i,:)  = time_BL(i-1,:) + DELTA_T_BL;
            time_N1(i,:)  = time_N1(i-1,:) + DELTA_T_N1;
            time_N2(i,:)  = time_N2(i-1,:) + DELTA_T_N2;
            time_N3(i,:)  = time_N3(i-1,:) + DELTA_T_N3;
        end
        
        
        
              
        %%
        %figure;
        plot(time_BL(:,end), 1-state_BL(:,end), 'r-.', 'linewidth', 2); hold on;
        plot(time_N1(:,end), 1-state_N1(:,end), 'g-.', 'linewidth', 2); hold on;
        plot(time_N2(:,end), 1-state_N2(:,end), 'b-.', 'linewidth', 2); hold on;
        plot(time_N3(:,end), 1-state_N3(:,end), 'm-.', 'linewidth', 2); hold on;

        ylabel('Reliability: (1-P_{instability})');
        xlabel('Iterations');

        grid on;
        grid minor;

        ylim([0 1]);

        legend('n=1 BL','n=1','n=2 f=[1 1]', 'n=3 f=[1 1]', 'location', 'best');
        
        %% settling time: estimatio of the probability of being reliable
        temp_reliability_BL     = 1-state_BL(end,:);
        temp_reliability_N1     = 1-state_N1(end,:);
        temp_reliability_N2     = 1-state_N2(end,:);
        temp_reliability_N3     = 1-state_N3(end,:);
        
        temp_mean_probability_BL = [temp_mean_probability_BL; mean(state_BL)];
        temp_mean_probability_N1 = [temp_mean_probability_N1; mean(state_N1)];
        temp_mean_probability_N2 = [temp_mean_probability_N2; mean(state_N2)];
        temp_mean_probability_N3 = [temp_mean_probability_N3; mean(state_N3)];
        
        % Settling probability
        TH = 0.00000001;
        
        info_temp_BL        = stepinfo(temp_reliability_BL,'SettlingTimeThreshold',TH);
        settling_temp_BL    = ceil(info_temp_BL.SettlingTime);
        reliability_BL(exp) = temp_reliability_BL(settling_temp_BL);
        
        info_temp_N1        = stepinfo(temp_reliability_N1,'SettlingTimeThreshold',TH);
        settling_temp_N1    = ceil(info_temp_N1.SettlingTime);
        reliability_N1(exp) = temp_reliability_N1(settling_temp_N1);
        
        info_temp_N2        = stepinfo(temp_reliability_N2,'SettlingTimeThreshold',TH);
        settling_temp_N2    = ceil(info_temp_N2.SettlingTime);
        reliability_N2(exp) = temp_reliability_N2(settling_temp_N2);
        
        info_temp_N3        = stepinfo(temp_reliability_N3,'SettlingTimeThreshold',TH);
        settling_temp_N3    = ceil(info_temp_N3.SettlingTime);
        reliability_N3(exp) = temp_reliability_N3(settling_temp_N3);
        
    end
    
    reliability_array_BL{sequence} = reliability_BL;
    reliability_array_N1{sequence} = reliability_N1;
    reliability_array_N2{sequence} = reliability_N2;
    reliability_array_N3{sequence} = reliability_N3;
    
    mean_BL{sequence} = temp_mean_probability_BL;
    mean_N1{sequence} = temp_mean_probability_N1;
    mean_N2{sequence} = temp_mean_probability_N2;
    mean_N3{sequence} = temp_mean_probability_N3;
    
end




%%
figure;
plot(reliability_array_BL{1}, 'r-o'); hold on;
plot(reliability_array_N1{1}, 'g-o'); hold on;
plot(reliability_array_N2{1}, 'b-o'); hold on;
plot(reliability_array_N2{2}, 'b->'); hold on;
plot(reliability_array_N3{1}, 'm-o'); hold on;
plot(reliability_array_N3{2}, 'm->'); hold on;
ylabel('Reliability [probability of being operational]');
xlabel('Ps [probability of fault at application slot]');

labels = min_ps:ps_granularity:max_ps;
set(gca, 'XTick', 1:length(labels)); % Change x-axis ticks
set(gca, 'XTickLabel', labels); % Change x-axis ticks labels.

grid on;
grid minor;

ylim([0 1]);

legend('n=1 BL','n=1','n=2 f=[1 1]', 'n=2 f=[4 4]', 'n=3 f=[1 1 1]', 'n=3 f=[4 4 4]', 'location', 'best');
